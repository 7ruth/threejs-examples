<!DOCTYPE html>
<html>
<head>
<title>sphere</title>
<style>
body {
	background: #333;
	overflow:hidden;
}
</style>
<script src="../lib/Three_r49.js"></script>
<script src="cannon.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function(){
	// Physics
	var world = new CANNON.World();
	world.gravity.set(0, -9.82 * 2, 0);
    world.broadphase = new CANNON.NaiveBroadphase();

	var sphereBodis = []; //Physics
	var sphereMeshs = []; //Visual


	var moveState = {
//		moving    : false,
		front     : false,
		backwards : false,
		left      : false,
		right     : false,
		jump      : false,
//		speed     : 10,
//		angle     : 0
	}


	init();
	createScene();
	animate();

	function init() {
		
		// scene
		scene = new THREE.Scene();
		
		// camera
		var width = window.innerWidth;
		var height = window.innerHeight;
		var near = 1;
		var far = 1000;
		camera = new THREE.PerspectiveCamera( 40, width / height, near, far );
		camera.position.set(0, 30, 50);
		camera.lookAt( scene.position );
		scene.add( camera );
	
		camera.lookAt( scene.position );
		scene.add( camera );
	
		// light
		var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
		light.position.set(1, 1, 1 );
		scene.add( light );
		
		// renderer
		renderer = new THREE.WebGLRenderer();
		renderer.setSize( width, height );
		document.body.appendChild( renderer.domElement );
		

	}

	function createScene( ) {
		// ground
		var geometry = new THREE.PlaneGeometry( 30, 30 );
		var planeMaterial = new THREE.MeshBasicMaterial( { color: 0xeeeeee } );
		var ground = new THREE.Mesh( geometry, planeMaterial );
		scene.add( ground );
		
		// ground plane
		var groundShape = new CANNON.Plane(new CANNON.Vec3(0, 1, 0));
		var groundBody = new CANNON.RigidBody(0, groundShape);
		world.add(groundBody);
		
		for(var i = 0; i < 10; i++){
			
			var mass = 5, radius = 1;
			
			// Visual(THREE)
			var sphereGeometry = new THREE.SphereGeometry( radius, 8, 8);
			var sphereMaterial = new THREE.MeshLambertMaterial( { color: Math.random() * 0xffffff,  wireframe: true } );
			var sphereMesh = new THREE.Mesh( sphereGeometry, sphereMaterial );
			scene.add( sphereMesh );
			sphereMesh.useQuaternion = true;
			
			// Physics
			var sphereShape = new CANNON.Sphere(radius);
			var sphereBody = new CANNON.RigidBody(mass,sphereShape);
			
			// start pos
			var randX = (Math.round(Math.random() * 9) + 1 - 5) * .2;
			var randZ = (Math.round(Math.random() * 9) + 1 - 5) * .2;
			var pos = new CANNON.Vec3(randX, i * 4 + 4, randZ);
			sphereBody.position.set(pos.x, pos.y, pos.z);
			
			// Save initial positions for later
			sphereBodis.push(sphereBody);
			sphereMeshs.push(sphereMesh);
			world.add(sphereBody);
		}
	}
	
	function animate(){
		move();
		updatePhysics();
		render();
		requestAnimationFrame( animate );
	}
	
	function updatePhysics(){
		// Step world
		world.step(1.0 / 60.0);
		for(var i = 0, l = sphereBodis.length; i < l; i++){
			sphereBodis[i].quaternion.copy(sphereMeshs[i].quaternion);
			sphereBodis[i].position.copy(sphereMeshs[i].position);
		}

		//sphereBodis[0].velocity = new CANNON.Vec3(0,0,0); //移動
		//sphereBodis[0].force.y = 60 //力
		sphereBodis[0].mass = 100 //重さ
		sphereBodis[0].tau = new CANNON.Vec3(0,0,0); //回転力
		sphereBodis[0].quaternion = new CANNON.Quaternion(0,0,0,1); //回転抑える
		sphereBodis[0].linearDamping = 0.5;//移動摩擦
		sphereBodis[0].angularDamping =  0.5;//回転摩擦
	}
	
	function render(){
		renderer.render( scene, camera );
	}

	function move(){
		var x = 0, z = 0;

		if( moveState.front){
			z = -1;
		}
		if( moveState.backwards){
			z = 1;
		}
		if( moveState.left){
			x = -1;
		}
		if( moveState.right){
			x = 1;
		}
		if(!!sphereBodis[0]){
			sphereBodis[0].velocity = new CANNON.Vec3(x * 10, 0, z * 10);
		}
		//box.applyCentralImpulse(new THREE.Vector3(x * 100, 0, z * 100));
	}

	window.addEventListener('keydown', function(e){
		// left or a 
		if(e.keyCode === 37 || e.keyCode === 65){
			moveState.left = true;
			moveState.right = false;
		}// up or w
		if(e.keyCode === 38 || e.keyCode === 87){
			moveState.front = true;
			moveState.backwards = false;
		}
		// right or d
		if(e.keyCode === 39 || e.keyCode === 68){
			moveState.right = true;
			moveState.left = false;
		}
		// down or s
		if(e.keyCode === 40 || e.keyCode === 83){
			moveState.backwards = true;
			moveState.front = false;
		}
		//if(!moveState.moving){
		//	moveState.moving = true;
		//}

		//space key
		if(e.keyCode === 32 && !moveState.jump){
			moveState.jump = true;
			var count = 0;
			jump();
		}

		function jump(){
			count++;
			var maxCount = 60;
			var fource = 300 * Math.max(0, (maxCount / 2) - count);
			console.log(fource)
			sphereBodis[0].force.y = fource; //力
			if(count < maxCount){
				requestAnimationFrame( jump );
			}else{
				moveState.jump = false;
			}
		}
	},false);

	window.addEventListener('keyup', function(e){
		// left or a 
		if(e.keyCode === 37 || e.keyCode === 65){
			moveState.left = false;
		}// up or w
		if(e.keyCode === 38 || e.keyCode === 87){
			moveState.front = false;
		}
		// right or d
		if(e.keyCode === 39 || e.keyCode === 68){
			moveState.right = false;
		}
		// down or s
		if(e.keyCode === 40 || e.keyCode === 83){
			moveState.backwards = false;
		}
	},false);

}, false);
</script>
</head>
<body>
</body>
</html>
