<html>
<head>
<title>THREE /w Box2dWeb</title>
<style>
canvas {border:1px solid #000;}
</style>
<script src="../lib/Three_r49.js"></script>
<script src="../lib/Box2dWeb-2.1.a.3.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function(){
		var b2Vec2 = Box2D.Common.Math.b2Vec2,
			 b2BodyDef = Box2D.Dynamics.b2BodyDef,
			 b2Body = Box2D.Dynamics.b2Body,
			 b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
			 b2Fixture = Box2D.Dynamics.b2Fixture,
			 b2World = Box2D.Dynamics.b2World,
			 b2MassData = Box2D.Collision.Shapes.b2MassData,
			 b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
			 b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
			 b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

		var world = new b2World(
			new b2Vec2(0, 9.80665), //gravity
			true							//allow sleep
		);

		var width = 600;//window.innerWidth;
		var height = 400;//window.innerHeight;

		var bodies = [];
		var meshs = [];

		var renderer, scene, camera;
		
		initScene();
		createObjects();
		animate();

		function initScene(){

			// renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setSize( width, height );
			document.body.appendChild( renderer.domElement );

			// scene
			scene = new THREE.Scene();
			
			// camera
			camera = new THREE.PerspectiveCamera( 40, width / height, 1, 1000 );
			camera.position.set(8, 0, 20);
			camera.lookAt( new THREE.Vector3( 8, -6, 0) );
			scene.add( camera );

		}

		function createObjects() {
			var fixDef = new b2FixtureDef;
			fixDef.density = 1.0;
			fixDef.friction = 0.5;
			fixDef.restitution = 0.2;
			
			var bodyDef = new b2BodyDef;
			var mesh;

			//create ground
			var groundWidth = 20;
			var groundHeight = 1;
			var groundX = 9;
			var groundY = 13;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.x = groundX;
			bodyDef.position.y = groundY;
			fixDef.shape = new b2PolygonShape;
			fixDef.shape.SetAsBox(groundWidth / 2, groundHeight / 2);
			world.CreateBody(bodyDef).CreateFixture(fixDef);
			var groundMesh = new THREE.Mesh(
				new THREE.CubeGeometry(groundWidth, groundHeight, 3),
				new THREE.MeshNormalMaterial()
			);
			groundMesh.position.set(groundX, groundY * -1, 0);
			scene.add( groundMesh );
			
			//create some objects
			bodyDef.type = b2Body.b2_dynamicBody;
			for(var i = 0; i < 10; ++i) {
				if(Math.random() > 0.5) {
					var boxWidth = Math.random() + 1;
					var boxHeight = Math.random() + 1;
					fixDef.shape = new b2PolygonShape;
					fixDef.shape.SetAsBox(boxWidth / 2, boxHeight / 2);

					mesh = new THREE.Mesh(
						new THREE.CubeGeometry(boxWidth, boxHeight, 3),
						new THREE.MeshNormalMaterial()
					);
				} else {
					var radius = Math.random() + 0.1; //radius
					fixDef.shape = new b2CircleShape(radius);

					mesh = new THREE.Mesh(
						new THREE.SphereGeometry(radius, 8, 8),
						new THREE.MeshNormalMaterial()
					);
				}
				bodyDef.position.x = Math.random() * 10;
				bodyDef.position.y = Math.random() * 10;
				bodies[i] = world.CreateBody(bodyDef);
				bodies[i].CreateFixture(fixDef);

				scene.add( mesh );
				meshs[i] = mesh;
			}
			
			//setup debug draw
			var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
			debugDraw.SetDrawScale(30.0);
			debugDraw.SetFillAlpha(0.3);
			debugDraw.SetLineThickness(1.0);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			world.SetDebugDraw(debugDraw);
		};

		function animate(){
			requestAnimationFrame( animate );
			updatePhysics();
			render();
		}

		function updatePhysics(){
			world.Step(
				1 / 60, //frame-rate
				10,     //velocity iterations
				10      //position iterations
			);
			world.DrawDebugData();
			world.ClearForces();

			for(var i = 0, l = bodies.length; i < l; i++){
				meshs[i].position.set(
					bodies[i].GetPosition().x,
					bodies[i].GetPosition().y * -1,
					0
				);
				meshs[i].rotation.set(
					0,
					0,
					bodies[i].GetAngle() * -1
				);
			}
		}

		function render(){
			renderer.render( scene, camera );
		}

}, false);
</script>
</head>
<body>
<canvas id="canvas" width="600" height="400"></canvas>
</body>
</html>